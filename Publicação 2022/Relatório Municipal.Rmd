---
title: Relatório Municipal de Indicadores
date:
author: "SAGICAD e SNAS / MDS"

documentclass: article

classoption: brazilian

header-includes:
  - \usepackage{babel}
  - \usepackage[utf8]{inputenc}
  - \usepackage{booktabs}
  - \usepackage{graphicx}
  - \usepackage{tabulary}
  - \usepackage{hyperref}
  - \usepackage{multirow}
  - \usepackage{chngcntr}
  - \usepackage{caption}
  - \usepackage{floatrow}
  - \floatsetup[figure]{capposition=top}
  - \floatsetup[table]{capposition=top}
  - \usepackage{titling}
  - \usepackage{cleveref}

output:
  pdf_document:
    number_sections: true
  html_document:
    number_sections: true
---

\addto\captionsbrazilian{\renewcommand{\figurename}{Gráfico}}
\crefname{figure}{gráfico}{gráficos}

<!-- \newcommand{\subtitle}[1]{% -->
  <!-- \posttitle{% -->
    <!-- \par\end{center} -->
    <!-- \begin{center}\large#1\end{center} -->
    <!-- \vskip0.5em}% -->
<!-- } -->


```{r setup, include=FALSE}
Sys.setlocale("LC_ALL","Portuguese_Brazil.utf8")

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

lista.de.pacotes = c("tinytex","tidyr", "purrr", "dplyr",
                     "lubridate","janitor","readxl","stringr",
                     "repmis","survey","srvyr","scales",
                     "ggrepel","renv") # escreva a lista de pacotes

novos.pacotes <- lista.de.pacotes[!(lista.de.pacotes %in%
                                      installed.packages()[,"Package"])]

if(length(novos.pacotes) > 0) {install.packages(novos.pacotes, repos = "http://cran.r-project.org")}
lapply(lista.de.pacotes, require, character.only=T)
rm(lista.de.pacotes,novos.pacotes)
gc()

hook_plot_tex_footer <- function(x, options) {  
  x_out <- knitr:::hook_plot_tex(x, options) 
  if(!is.null(options$fig.footer)) {
    inter <- sprintf("\\floatfoot{%s}\n\\end{figure}", options$fig.footer[1])
    x_out <- gsub(x=x_out, pattern="\n\\end{figure}", replacement=inter, fixed=TRUE)
  }
  x_out
}

knitr::knit_hooks$set(plot=hook_plot_tex_footer)

# Município

municipio = 355030 # São Paulo
#municipio = 316660 # Menor Município
#municipio = 330455 # Rio de Janeiro
#municipio = 110028  # CRAS EF nível 1
#municipio = 110005  # CRAS EF nível 3
#municipio = 110007  # CRAS EF nível 4

dados_municipio <- read_excel("../RELATORIO_DTB_BRASIL_MUNICIPIO.xls", skip = 6) %>%
                    mutate(`Código Município` = substr(`Código Município Completo`,1,6)) %>%
                    filter(`Código Município` == municipio)

nome_municipio <- dados_municipio %>% pull(Nome_Município)
uf_municipio <- dados_municipio %>% pull(Nome_UF)

```

---
subtitle: `r nome_municipio`, `r uf_municipio`
---

\counterwithout{figure}{section}
\counterwithout{table}{section}
\counterwithout{footnote}{section}
\captionsetup[figure]{labelfont=bf,textfont=bf}
\captionsetup[table]{labelfont=bf,textfont=bf}
\newcommand\fnote[1]{\captionsetup{font=small, textfont=normalfont}\caption*{#1}}
\captionsetup{justification=raggedright,singlelinecheck=false}

```{r carregamento, cache=TRUE}

idconselho_2014 <- read_excel("../ID CONSELHO/IDConselho2014_alterado_08-12-2016.xlsx",sheet = 1)
idconselho_2015 <- read_excel("../ID CONSELHO/ID CONSELHO - 2015.xlsx",sheet = 1)
idconselho_2016 <- read_excel("../ID CONSELHO/ID CONSELHO - 2016.xlsx",sheet = 1)
idconselho_2017 <- read_excel("../ID CONSELHO/ID CONSELHO - 2017.xlsx",sheet = 1)
idconselho_2018 <- read_excel("../ID CONSELHO/ID CONSELHO - 2018.xlsx",sheet = 1)
idconselho_2019 <- read_excel("../ID CONSELHO/ID CONSELHO - 2019.xlsx",sheet = 1,guess_max=7)
idconselho_2020 <- read_excel("../ID CONSELHO/ID CONSELHO - 2020.xlsx",sheet = 1,guess_max=12)
idconselho_2021 <- read_excel("../ID CONSELHO/IDCONSELHO_2021_divulgacao.xlsx",guess_max=140)
idconselho_2022 <- read_excel("../ID CONSELHO/IDConselho_Municipal_2022_divulgacao.xlsx",sheet = 1)

idcras_2014 <- read_excel("../ID CRAS/NOVO_IDCRAS_2014_divulgação_retificado_07_10_2016.xlsx",sheet = 1)
idcras_2015 <- read_excel("../ID CRAS/NOVO_IDCRAS_2015_divulgação_retificado_07_10_2016.xlsx",sheet = 1)
idcras_2016 <- read_excel("../ID CRAS/IDCRAS_2016_FINAL_(01062017).xlsx",sheet = 1)
idcras_2017 <- read_excel("../ID CRAS/IDCRAS_2017_DIVULGAÇÃO_atualizado__030523.xlsx",sheet = 2, skip=6)
idcras_2018 <- read_excel("../ID CRAS/IDCRAS_2018_DIVULGAÇÃO_atualizado_280423.xlsx",sheet = 1)
idcras_2019 <- read_excel("../ID CRAS/IDCRAS_2019_DIVULGAÇÃO_atualizado_280423.xlsx",sheet = 1)
idcras_2020 <- read_excel("../ID CRAS/IDCRAS_2020_DIVULGAÇÃO_atualizado_280423(1).xlsx",sheet = 1)
idcras_2021 <- read_excel("../ID CRAS/IDCRAS_2021_DIVULGAÇÃO_atulaizado_280423(1).xlsx",sheet = 1)
idcras_2022 <- read_excel("../ID CRAS/IDCRAS_2022_DIVULGAÇÃO_atualizado_280423(1).xlsx",sheet = 1)

cras_2022 <- read_excel("../Censo SUAS 2022/1_CRAS/Censo_SUAS_2022_CRAS_Dados_Gerais_Divulgação.xlsx", sheet = 1)
idcras_2022 <- idcras_2022 %>% merge(cras_2022, by.x = "Nº IDENTIFICADOR do CRAS", by.y = "NU_IDENTIFICADOR")
  
idcreas_2014 <- read_excel("../ID CREAS/IDCREAS_2014_DIVULGACAO_site.xlsx",sheet = 1)
idcreas_2015 <- read_excel("../ID CREAS/ID_CREAS_2015_divulgacao_site.xlsx",sheet = 1)
idcreas_2016 <- read_excel("../ID CREAS/IDCREAS_2016_DIVULGAÇÃO.xlsx",sheet = 1)
idcreas_2017 <- read_excel("../ID CREAS/IDCREAS_2017_DIVULGAÇÃO (2).xlsx",sheet = 1)
idcreas_2018 <- read_excel("../ID CREAS/IDCREAS2018_divulgacao(2).xlsx",sheet = 1)
idcreas_2019 <- read_excel("../ID CREAS/IDCREAS2019_divulgacao.xlsx",sheet = 1)
idcreas_2020 <- read_excel("../ID CREAS/IDCREAS2020_divulgacao.xlsx",sheet = 1)
idcreas_2021 <- read_excel("../ID CREAS/IDCREAS2021_divulgacao_retificado191022(1) (1).xlsx",sheet = 1)
idcreas_2022 <- read_excel("../ID CREAS/IDCREAS2022_divulgacao_retificado270923.xlsx",sheet = 1)

```

```{r funcoes}

f_quantitativo_filtro = function(df, q_filtro, filtro, q_grupo, eixo_x){
  q_filtro <- enquo(q_filtro)
  filtro <- quo_name(filtro)
  q_grupo <- enquo(q_grupo)
  eixo_x <- quo_name(eixo_x)

  df %>%
    filter(!! q_filtro == !! filtro) %>% 
    select(!! q_grupo) %>% 
    group_by(!! q_grupo) %>% 
    summarise(n=n()) %>% 
    mutate("Eixo_X" = !! eixo_x) %>%  
    mutate("Grupo" = !! q_grupo) 
}

f_selecao_grupo_media = function(df, q_selecao, selecao, q_media, grupo, eixo_x){
  q_selecao <- enquo(q_selecao)
  grupo <- quo_name(grupo)
  selecao <- quo_name(selecao)
  q_media <- enquo(q_media)
  eixo_x <- quo_name(eixo_x)

  df %>%
    select(!! q_selecao, !! q_media) %>% 
    filter(!! q_selecao == !! selecao) %>% 
    filter(!is.na(!! q_media)) %>% 
    summarise(m=mean(!! q_media)) %>% 
    mutate("Eixo_X" = !! eixo_x) %>% 
    mutate("Grupo" = !! grupo) 
}

```

# ID CRAS

```{r ID-CRAS, fig.cap = sprintf(" Evolução das médias do ID CRAS, 2014 a 2022: %s, %s", nome_municipio, uf_municipio), fig.footer = "Fonte: MDS, Censo SUAS."}

grafico <- f_selecao_grupo_media(idcras_2014, IBGE, municipio, `IDCRAS 2014sintético`, "ID CRAS", "2014") %>%
  bind_rows(f_selecao_grupo_media(idcras_2014, IBGE, municipio, `Dimensão Estrutura Física`, "Estrutura Física", "2014")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2014, IBGE, municipio, `Dimensão Recursos Humanos`, "Recursos Humanos", "2014")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2014, IBGE, municipio, `Dimensão Serviços & Benefícios`, "Serviços", "2014")) %>%

  bind_rows(f_selecao_grupo_media(idcras_2015, IBGE, municipio, `IDCRAS 2015 sintético`, "ID CRAS", "2015")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2015, IBGE, municipio, `Dimensão Estrutura Física`, "Estrutura Física", "2015")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2015, IBGE, municipio, `Dimensão Recursos Humanos`, "Recursos Humanos", "2015")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2015, IBGE, municipio, `Dimensão Serviços & Benefícios`, "Serviços", "2015")) %>%
  
  bind_rows(f_selecao_grupo_media(idcras_2016, IBGE, municipio, `IDCRAS 2016sintético`, "ID CRAS", "2016")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2016, IBGE, municipio, `Dimensão Estrutura Física`, "Estrutura Física", "2016")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2016, IBGE, municipio, `Dimensão Recursos Humanos`, "Recursos Humanos", "2016")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2016, IBGE, municipio, `Dimensão Serviços & Benefícios`, "Serviços", "2016")) %>%
  
  bind_rows(f_selecao_grupo_media(idcras_2017, `Código IBGE`, municipio, IDCRAS, "ID CRAS", "2017")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2017, `Código IBGE`, municipio, `Estrutura Física`, "Estrutura Física", "2017")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2017, `Código IBGE`, municipio, `Recursos Humanos`, "Recursos Humanos", "2017")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2017, `Código IBGE`, municipio, `Serviços `, "Serviços", "2017")) %>%
  
  bind_rows(f_selecao_grupo_media(idcras_2018, `Código IBGE`, municipio, IDCRAS, "ID CRAS", "2018")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2018, `Código IBGE`, municipio, `Estrutura Física`, "Estrutura Física", "2018")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2018, `Código IBGE`, municipio, `Recursos Humanos`, "Recursos Humanos", "2018")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2018, `Código IBGE`, municipio, `Serviços `, "Serviços", "2018")) %>%
  
  bind_rows(f_selecao_grupo_media(idcras_2019, `Código IBGE`, municipio, IDCRAS, "ID CRAS", "2019")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2019, `Código IBGE`, municipio, `Estrutura Física`, "Estrutura Física", "2019")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2019, `Código IBGE`, municipio, `Recursos Humanos`, "Recursos Humanos", "2019")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2019, `Código IBGE`, municipio, `Serviços `, "Serviços", "2019")) %>%
  
  bind_rows(f_selecao_grupo_media(idcras_2020, `Código IBGE`, municipio, IDCRAS, "ID CRAS", "2020")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2020, `Código IBGE`, municipio, `Estrutura Física`, "Estrutura Física", "2020")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2020, `Código IBGE`, municipio, `Recursos Humanos`, "Recursos Humanos", "2020")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2020, `Código IBGE`, municipio, `Serviços `, "Serviços", "2020")) %>%
  
  bind_rows(f_selecao_grupo_media(idcras_2021, `Código IBGE`, municipio, IDCRAS, "ID CRAS", "2021")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2021, `Código IBGE`, municipio, `Estrutura Física`, "Estrutura Física", "2021")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2021, `Código IBGE`, municipio, `Recursos Humanos`, "Recursos Humanos", "2021")) %>%
  bind_rows(f_selecao_grupo_media(idcras_2021, `Código IBGE`, municipio, `Serviços `, "Serviços", "2021")) %>%
  
  bind_rows(f_selecao_grupo_media(idcras_2022, `Código IBGE`, municipio, IDCRAS, "ID CRAS", "2022")) %>% 
  bind_rows(f_selecao_grupo_media(idcras_2022, `Código IBGE`, municipio, `Estrutura Física`, "Estrutura Física", "2022")) %>% 
  bind_rows(f_selecao_grupo_media(idcras_2022, `Código IBGE`, municipio, `Recursos Humanos`, "Recursos Humanos", "2022")) %>% 
  bind_rows(f_selecao_grupo_media(idcras_2022, `Código IBGE`, municipio, `Serviços `, "Serviços", "2022")) %>% 

  mutate(Grupo = factor(Grupo, levels = c("Estrutura Física",
                                          "Recursos Humanos",
                                          "Serviços",
                                          "ID CRAS"))) %>% 

  ggplot(aes(x = Eixo_X, y = m, group = Grupo)) +
  geom_col(aes(fill = Grupo), position="dodge") +
  geom_text(aes(label = sprintf("%0.2f", m), y=m+0.3), position = position_dodge(width = 0.9), angle = 90, size = 3) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .1))) +
  theme(legend.position="bottom",
        legend.title = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.line.x = element_line(),
        panel.background = element_blank()) +
  guides(fill=guide_legend(nrow=1,byrow=TRUE))

grafico
```

```{r}
cras_municipio <- idcras_2022 %>%
                    filter(`Código IBGE` == municipio)

n_cras <- nrow(cras_municipio)
```

```{r ID-CRAS-nivel, fig.cap = sprintf("Quantidade de CRAS em cada nível de ID, 2022: %s, %s", nome_municipio, uf_municipio), fig.footer = "Fonte: MDS, Censo SUAS.", eval=n_cras>1}

grafico <- f_quantitativo_filtro(idcras_2022, `Código IBGE`, municipio, `Estrutura Física`, "Estrutura Física") %>% 
  bind_rows(f_quantitativo_filtro(idcras_2022, `Código IBGE`, municipio, `Recursos Humanos`, "Recursos Humanos")) %>%   bind_rows(f_quantitativo_filtro(idcras_2022, `Código IBGE`, municipio, `Serviços `, "Serviços")) %>% 

  mutate(Eixo_X = factor(Eixo_X, levels = c("Estrutura Física",
                                            "Recursos Humanos",
                                            "Serviços"))) %>% 
  mutate(Grupo = factor(Grupo, levels = c(1, 2, 3, 4, 5))) %>% 

  ggplot(aes(x = Eixo_X, y = n, group = Grupo)) +
  geom_col(aes(fill = Grupo), position="dodge") +
  geom_text(aes(label = sprintf("%d", n)), position = position_dodge(width = 0.9), vjust = -0.5) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .1))) +
  theme(legend.position="bottom",
        legend.title = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.line.x = element_line(),
        panel.background = element_blank()) +
  guides(fill=guide_legend(nrow=1,byrow=TRUE))

grafico
```

## Dimensão Estrutura Física do ID CRAS

### Dimensão Estrutura Física do ID CRAS nos CRAS com capacidade de referenciamento para até 2.500 ou 3.500 famílias

```{r}
cras_menores <- cras_municipio %>%
                  filter(q1 == "2.500 famílias referenciadas" | q1 == "3.500 famílias referenciadas")
n_cras_menores <- nrow(cras_menores)
if(n_cras_menores) {
  menor_nivel_cras_menores_ef <- min(cras_menores$`Estrutura Física`, na.rm = T)
  maior_nivel_cras_menores_ef <- max(cras_menores$`Estrutura Física`, na.rm = T)
}
```

```{r eval=!n_cras_menores, results='asis', echo=FALSE}

cat(nome_municipio, "não tem CRAS com capacidade de referenciamento para até 2.500 ou 3.500 famílias.")
```

```{r eval=n_cras_menores==1, results='asis', echo=FALSE}

cat("Na dimensão estrutura física, o nível de ID do CRAS com capacidade de referenciamento para até 2.500 ou 3.500 famílias no município de ", nome_municipio, " é ",  menor_nivel_cras_menores_ef, ".", sep = "")
```

```{r eval=(n_cras_menores>1 && (menor_nivel_cras_menores_ef == maior_nivel_cras_menores_ef)), results='asis', echo=FALSE}

cat("Na dimensão estrutura física, o nível de ID dos CRAS com capacidade de referenciamento para até 2.500 ou 3.500 famílias no município de ", nome_municipio, " é ", menor_nivel_cras_menores_ef, ".", sep = "")
```

```{r eval=(n_cras_menores>1 && (menor_nivel_cras_menores_ef < maior_nivel_cras_menores_ef)), results='asis', echo=FALSE}

cat("Na dimensão estrutura física, o nível de ID dos CRAS com capacidade de referenciamento para até 2.500 ou 3.500 famílias no município de ", nome_municipio, " varia de ", menor_nivel_cras_menores_ef, " a ", maior_nivel_cras_menores_ef, ".", sep = "")
```

```{asis, echo = n_cras_menores>0 && menor_nivel_cras_menores_ef==1}

O CRAS de **nível 1**, com capacidade de referenciamento para até 2.500 ou 3.500 famílias, na dimensão **estrutura física**:

* Possui **menos de 2 salas de atendimento**; ou
* **Não possui banheiro**; ou
* Funciona em **prédio compartilhado com ONG, ou com compartilhamento de todas as salas de atendimento**.

Para alcançar o **nível 2** na dimensão **estrutura física**, o CRAS com capacidade de referenciamento para até 2.500 ou 3.500 famílias precisa:

* Possuir, no mínimo, **2 salas de atendimento**; e
* Possuir, pelo menos, **1 banheiro**.

```

```{asis, echo = n_cras_menores>0 && menor_nivel_cras_menores_ef==2}

O CRAS de **nível 2**, com capacidade de referenciamento para até 2.500 ou 3.500 famílias, na dimensão **estrutura física**:

* Possui, no mínimo, **2 salas de atendimento**; e
* Possui, pelo menos, **1 banheiro**.

```

```{asis, echo = n_cras_menores>0 && menor_nivel_cras_menores_ef<3 && maior_nivel_cras_menores_ef>1}

Para alcançar o **nível 3** na dimensão **estrutura física**, o CRAS com capacidade de referenciamento para até 2.500 ou 3.500 famílias precisa:

* Possuir **recepção**; e
* Possuir **acessibiliadade, ao menos parcial**.

```

```{asis, echo = n_cras_menores>0 && menor_nivel_cras_menores_ef==3}

O CRAS de **nível 3**, com capacidade de referenciamento para até 2.500 ou 3.500 famílias, na dimensão **estrutura física**:

* Possui **recepção**; e
* Possui, no mínimo, **2 salas de atendimento**; e
* Possui, pelo menos, **1 banheiro**; e
* Possui **acessibiliadade, ao menos parcial**.

```

```{asis, echo = n_cras_menores>0 && menor_nivel_cras_menores_ef<4 && maior_nivel_cras_menores_ef>2}

Para alcançar o **nível 4** na dimensão **estrutura física**, o CRAS com capacidade de referenciamento para até 2.500 ou 3.500 famílias precisa:

* Possuir, no mínimo, **2 salas de atendimento**, sendo **pelo menos 1 com capacidade para 15 ou mais pessoas**; e
* Possuir, no mínimo, **2 banheiros**; e
* Possuir **pelo menos 1 computador conectado**.

```

```{asis, echo = n_cras_menores>0 && menor_nivel_cras_menores_ef==4}

O CRAS de **nível 4**, com capacidade de referenciamento para até 2.500 ou 3.500 famílias, na dimensão **estrutura física**:

* Possui **recepção**; e
* Possui, no mínimo, **2 salas de atendimento**, sendo **pelo menos 1 com capacidade para 15 ou mais pessoas**; e
* Possui, no mínimo, **2 banheiros**; e
* Possui **acessibiliadade, ao menos parcial**; e
* Possui **pelo menos 1 computador conectado**.

```

```{asis, echo = n_cras_menores>0 && menor_nivel_cras_menores_ef<5 && maior_nivel_cras_menores_ef>3}

Para alcançar o **nível 5** na dimensão **estrutura física**, o CRAS com capacidade de referenciamento para até 2.500 ou 3.500 famílias precisa:

* Possuir, no mínimo, **1 sala administrativa**; e
* Possuir **acessibilidade**; e
* Possuir conjunto de equipamentos que inclua, no mínimo: **2 computadores conectados à internet, impressora, telefone e veículo exclusivo ou compartilhado**.

```

```{asis, echo = n_cras_menores>0 && menor_nivel_cras_menores_ef==5}

O CRAS de **nível 5**, com capacidade de referenciamento para até 2.500 ou 3.500 famílias, na dimensão **estrutura física**:

* Possui **recepção**; e
* Possui, no mínimo, **2 salas de atendimento**, sendo **pelo menos 1 com capacidade para 15 ou mais pessoas**; e
* Possui, no mínimo, **1 sala administrativa**; e
* Possui, no mínimo, **2 banheiros**; e
* Possui **acessibiliadade**; e
* Possui conjunto de equipamentos que inclua, no mínimo: **2 computadores conectados à internet, impressora, telefone e veículo exclusivo ou compartilhado**.

```

```{r ID-CREAS, fig.cap = sprintf(" Evolução das médias do ID CREAS, 2014 a 2022: %s, %s", nome_municipio, uf_municipio), fig.footer = "Fonte: MDS, Censo SUAS."}

grafico <- f_selecao_grupo_media(idcreas_2014, `Código IBGE`, municipio, `IDCREAS sintético`, "ID CREAS", "2014") %>%
  bind_rows(f_selecao_grupo_media(idcreas_2014, `Código IBGE`, municipio, `Dimensão Estrutura Física`, "Estrutura Física", "2014")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2014, `Código IBGE`, municipio, `Dimensão Recursos Humanos`, "Recursos Humanos", "2014")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2014, `Código IBGE`, municipio, `Dimensão Serviços`, "Serviços", "2014")) %>%

  bind_rows(f_selecao_grupo_media(idcreas_2015, IBGE6, municipio, `IDCREAS sintético`, "ID CREAS", "2015")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2015, IBGE6, municipio, `Dimensão Estrutura Física`, "Estrutura Física", "2015")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2015, IBGE6, municipio, `Dimensão Recursos Humanos`, "Recursos Humanos", "2015")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2015, IBGE6, municipio, `Dimensão Serviços`, "Serviços", "2015")) %>%
  
  bind_rows(f_selecao_grupo_media(idcreas_2016, IBGE, municipio, `IDCREAS 2016`, "ID CREAS", "2016")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2016, IBGE, municipio, `Dimensão Estrutura Física`, "Estrutura Física", "2016")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2016, IBGE, municipio, `Dimensão Recursos Humanos`, "Recursos Humanos", "2016")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2016, IBGE, municipio, `Dimensão Serviços`, "Serviços", "2016")) %>%
  
  bind_rows(f_selecao_grupo_media(idcreas_2017, `Código IBGE`, municipio, IDCREAS, "ID CREAS", "2017")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2017, `Código IBGE`, municipio, `Estrutura Física`, "Estrutura Física", "2017")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2017, `Código IBGE`, municipio, `Recursos Humanos`, "Recursos Humanos", "2017")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2017, `Código IBGE`, municipio, `Serviços `, "Serviços", "2017")) %>%
  
  bind_rows(f_selecao_grupo_media(idcreas_2018, IBGE, municipio, ID_CREAS, "ID CREAS", "2018")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2018, IBGE, municipio, EF, "Estrutura Física", "2018")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2018, IBGE, municipio, `RH`, "Recursos Humanos", "2018")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2018, IBGE, municipio, `SERV`, "Serviços", "2018")) %>%
  
  bind_rows(f_selecao_grupo_media(idcreas_2019, IBGE, municipio, ID_CREAS, "ID CREAS", "2019")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2019, IBGE, municipio, `EF`, "Estrutura Física", "2019")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2019, IBGE, municipio, `RH`, "Recursos Humanos", "2019")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2019, IBGE, municipio, `SERV`, "Serviços", "2019")) %>%
  
  bind_rows(f_selecao_grupo_media(idcreas_2020, IBGE, municipio, ID_CREAS, "ID CREAS", "2020")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2020, IBGE, municipio, `EF`, "Estrutura Física", "2020")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2020, IBGE, municipio, `RH`, "Recursos Humanos", "2020")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2020, IBGE, municipio, `SERV`, "Serviços", "2020")) %>%
  
  bind_rows(f_selecao_grupo_media(idcreas_2021, IBGE, municipio, ID_CREAS, "ID CREAS", "2021")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2021, IBGE, municipio, `EF`, "Estrutura Física", "2021")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2021, IBGE, municipio, `RH`, "Recursos Humanos", "2021")) %>%
  bind_rows(f_selecao_grupo_media(idcreas_2021, IBGE, municipio, `SERV`, "Serviços", "2021")) %>%
  
  bind_rows(f_selecao_grupo_media(idcreas_2022, `Código IBGE`, municipio, idcreas, "ID CREAS", "2022")) %>% 
  bind_rows(f_selecao_grupo_media(idcreas_2022, `Código IBGE`, municipio, `Estrutura Física`, "Estrutura Física", "2022")) %>% 
  bind_rows(f_selecao_grupo_media(idcreas_2022, `Código IBGE`, municipio, `Recursos Humanos`, "Recursos Humanos", "2022")) %>% 
  bind_rows(f_selecao_grupo_media(idcreas_2022, `Código IBGE`, municipio, `Serviços `, "Serviços", "2022")) %>% 

  mutate(Grupo = factor(Grupo, levels = c("Estrutura Física",
                                          "Recursos Humanos",
                                          "Serviços",
                                          "ID CREAS"))) %>% 

  ggplot(aes(x = Eixo_X, y = m, group = Grupo)) +
  geom_col(aes(fill = Grupo), position="dodge") +
  geom_text(aes(label = sprintf("%0.2f", m), y=m+0.3), position = position_dodge(width = 0.9), angle = 90, size = 3) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .1))) +
  theme(legend.position="bottom",
        legend.title = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.line.x = element_line(),
        panel.background = element_blank()) +
  guides(fill=guide_legend(nrow=1,byrow=TRUE))

grafico
```

```{r ID-CREAS-nivel, fig.cap = sprintf("Quantidade de CREAS em cada nível de ID, 2022: %s, %s", nome_municipio, uf_municipio), fig.footer = "Fonte: MDS, Censo SUAS."}

grafico <- f_quantitativo_filtro(idcreas_2022, `Código IBGE`, municipio, `Estrutura Física`, "Estrutura Física") %>% 
  bind_rows(f_quantitativo_filtro(idcreas_2022, `Código IBGE`, municipio, `Recursos Humanos`, "Recursos Humanos")) %>%   bind_rows(f_quantitativo_filtro(idcreas_2022, `Código IBGE`, municipio, `Serviços `, "Serviços")) %>% 

  mutate(Eixo_X = factor(Eixo_X, levels = c("Estrutura Física",
                                            "Recursos Humanos",
                                            "Serviços"))) %>% 
  mutate(Grupo = factor(Grupo, levels = c(1, 2, 3, 4, 5))) %>% 

  ggplot(aes(x = Eixo_X, y = n, group = Grupo)) +
  geom_col(aes(fill = Grupo), position="dodge") +
  geom_text(aes(label = sprintf("%d", n)), position = position_dodge(width = 0.9), vjust = -0.5) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .1))) +
  theme(legend.position="bottom",
        legend.title = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.line.x = element_line(),
        panel.background = element_blank()) +
  guides(fill=guide_legend(nrow=1,byrow=TRUE))

grafico
```

```{r ID-conselho, fig.cap = sprintf(" Evolução das médias do ID Conselho, 2014 a 2022: %s, %s", nome_municipio, uf_municipio), fig.footer = "Fonte: MDS, Censo SUAS."}

grafico <- f_selecao_grupo_media(idconselho_2014, IBGE, municipio, IDConselho, "ID Conselho", "2014") %>%
  bind_rows(f_selecao_grupo_media(idconselho_2014, IBGE, municipio, `Estrutura Administrativa`, "Estrutura Administrativa", "2014")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2014, IBGE, municipio, `Dinâmica de Funcionamento`, "Dinâmica de Funcionamento", "2014")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2014, IBGE, municipio, `Composição do Conselho`, "Composição do Conselho", "2014")) %>%

  bind_rows(f_selecao_grupo_media(idconselho_2015, IBGE, municipio, `IDConselho - 2015`, "ID Conselho", "2015")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2015, IBGE, municipio, `Estrutura Administrativa`, "Estrutura Administrativa", "2015")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2015, IBGE, municipio, `Dinâmica de Funcionamento`, "Dinâmica de Funcionamento", "2015")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2015, IBGE, municipio, `Composição do Conselho`, "Composição do Conselho", "2015")) %>%
  
  bind_rows(f_selecao_grupo_media(idconselho_2016, IBGE, municipio, IDConselho, "ID Conselho", "2016")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2016, IBGE, municipio, `Estrutura Administrativa`, "Estrutura Administrativa", "2016")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2016, IBGE, municipio, `Dinâmica de Funcionamento`, "Dinâmica de Funcionamento", "2016")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2016, IBGE, municipio, `Composição do Conselho`, "Composição do Conselho", "2016")) %>%
  
  bind_rows(f_selecao_grupo_media(idconselho_2017, IBGE, municipio, IDConselho, "ID Conselho", "2017")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2017, IBGE, municipio, `Estrutura Administrativa`, "Estrutura Administrativa", "2017")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2017, IBGE, municipio, `Dinâmica de Funcionamento`, "Dinâmica de Funcionamento", "2017")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2017, IBGE, municipio, `Composição do Conselho`, "Composição do Conselho", "2017")) %>%
  
  bind_rows(f_selecao_grupo_media(idconselho_2018, IBGE, municipio, IDConselho, "ID Conselho", "2018")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2018, IBGE, municipio, `Estrutura Administrativa`, "Estrutura Administrativa", "2018")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2018, IBGE, municipio, `Dinâmica de Funcionamento`, "Dinâmica de Funcionamento", "2018")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2018, IBGE, municipio, `Composição do Conselho`, "Composição do Conselho", "2018")) %>%
  
  bind_rows(f_selecao_grupo_media(idconselho_2019, IBGE, municipio, IDConselho, "ID Conselho", "2019")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2019, IBGE, municipio, `Estrutura Administrativa`, "Estrutura Administrativa", "2019")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2019, IBGE, municipio, `Dinâmica de Funcionamento`, "Dinâmica de Funcionamento", "2019")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2019, IBGE, municipio, `Composição do Conselho`, "Composição do Conselho", "2019")) %>%
  
  bind_rows(f_selecao_grupo_media(idconselho_2020, IBGE, municipio, IDConselho, "ID Conselho", "2020")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2020, IBGE, municipio, `Estrutura Administrativa`, "Estrutura Administrativa", "2020")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2020, IBGE, municipio, `Dinâmica de Funcionamento`, "Dinâmica de Funcionamento", "2020")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2020, IBGE, municipio, `Composição do Conselho`, "Composição do Conselho", "2020")) %>%
  
  bind_rows(f_selecao_grupo_media(idconselho_2021, IBGE, municipio, IDConselho, "ID Conselho", "2021")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2021, IBGE, municipio, `Estrutura Administrativa`, "Estrutura Administrativa", "2021")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2021, IBGE, municipio, `Dinâmica de Funcionamento`, "Dinâmica de Funcionamento", "2021")) %>%
  bind_rows(f_selecao_grupo_media(idconselho_2021, IBGE, municipio, `Composição do Conselho`, "Composição do Conselho", "2021")) %>%
  
  bind_rows(f_selecao_grupo_media(idconselho_2022, IBGE7, municipio, IDConselho, "ID Conselho", "2022")) %>% 
  bind_rows(f_selecao_grupo_media(idconselho_2022, IBGE7, municipio, `Estrutura Administrativa`, "Estrutura Administrativa", "2022")) %>% 
  bind_rows(f_selecao_grupo_media(idconselho_2022, IBGE7, municipio, `Dinâmica de Funcionamento`, "Dinâmica de Funcionamento", "2022")) %>% 
  bind_rows(f_selecao_grupo_media(idconselho_2022, IBGE7, municipio, `Composição do Conselho`, "Composição do Conselho", "2022")) %>% 

  mutate(Grupo = factor(Grupo, levels = c("Estrutura Administrativa",
                                          "Dinâmica de Funcionamento",
                                          "Composição do Conselho",
                                          "ID Conselho"))) %>% 

  ggplot(aes(x = Eixo_X, y = m, group = Grupo)) +
  geom_col(aes(fill = Grupo), position="dodge") +
  geom_text(aes(label = sprintf("%0.2f", m), y=m+0.3), position = position_dodge(width = 0.9), angle = 90, size = 3) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .1))) +
  theme(legend.position="bottom",
        legend.title = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.line.x = element_line(),
        panel.background = element_blank()) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))

grafico
```
